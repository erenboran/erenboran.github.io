<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Stats Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #171717;
        }
        .bg-custom-purple {
            background-color: #8A2BE2;
        }
        .text-custom-purple {
            color: #8A2BE2;
        }
        .bg-custom-orange {
            background-color: #f58220;
        }
        .text-custom-orange {
            color: #f58220;
        }
        .target-button {
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            border: 2px solid;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            user-select: none;
        }
        .target-button.selected {
            background-color: #f58220;
            color: white;
            border-color: #f58220;
        }
        .target-button:not(.selected) {
            background-color: transparent;
            color: #f58220;
            border-color: #f58220;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem 2rem;
            background-color: #333;
            color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            font-size: 0.75rem;
        }
        .tooltip-container {
            position: relative;
        }
        .tooltip-container:hover .tooltip {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-[#171717] text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container bg-gray-900 p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto border-4 border-custom-purple">
        <h1 class="text-3xl font-bold text-center text-custom-purple mb-4">Tower Stats Calculator</h1>
        <p class="text-center text-gray-400 mb-8">
            Create new tower stats by entering formulas and adjusting multipliers.
        </p>

        <div id="copy_notification" class="modal hidden">
            KopyalandÄ±!
        </div>
        
        <!-- Controls Section -->
        <div class="p-6 bg-gray-800 rounded-xl shadow-md border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold text-custom-purple mb-4">Calculation Controls</h2>
            
            <!-- Base Variables Section -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="tooltip-container">
                    <label for="base_dps" class="block text-sm font-medium text-gray-400">Base DPS</label>
                    <input type="number" id="base_dps" value="180" step="1" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                    <span class="tooltip">The tower's base DPS value.</span>
                </div>
                <div class="tooltip-container">
                    <label for="base_aspd" class="block text-sm font-medium text-gray-400">Base Attack Speed</label>
                    <input type="number" id="base_aspd" value="80" step="1" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                    <span class="tooltip">The tower's base Attack Speed value.</span>
                </div>
                <div class="tooltip-container">
                    <label for="dmg_increment_per_tier" class="block text-sm font-medium text-gray-400">Damage Increment per Tier</label>
                    <input type="number" id="dmg_increment_per_tier" value="25" step="1" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                    <span class="tooltip">The fixed amount of damage added to DPS for each tier level.</span>
                </div>
            </div>

            <!-- Manual Formula Section -->
            <div class="space-y-4 mt-8">
                <div class="tooltip-container">
                    <label for="dps_formula" class="block text-sm font-medium text-gray-400">DPS Formula</label>
                    <input type="text" id="dps_formula" value="({{base_dps}} * {{rarity_mult}}) + ({{dmg_increment}} * ({{tier}} - 1))" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                    <span class="tooltip">
                        Enter an Excel-like formula. <br/>
                        Available variables:
                        <br/>`{{tier}}` (Tier value)
                        <br/>`{{rarity_mult}}` (Rarity DPS multiplier)
                        <br/>`{{base_dps}}` (Base DPS value)
                        <br/>`{{dmg_increment}}` (Damage increment per tier)
                    </span>
                </div>
                <div class="tooltip-container">
                    <label for="aspd_formula" class="block text-sm font-medium text-gray-400">Attack Speed Formula</label>
                    <input type="text" id="aspd_formula" value="{{base_aspd}} * {{rarity_mult_aspd}}" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                    <span class="tooltip">
                        Formula for Attack Speed. <br/>
                        Available variables: `{{rarity_mult_aspd}}` (Rarity Attack Speed multiplier)
                        <br/>`{{base_aspd}}` (Base Attack Speed value)
                    </span>
                </div>
                <div class="tooltip-container">
                    <label for="range_formula" class="block text-sm font-medium text-gray-400">Range Formula</label>
                    <input type="text" id="range_formula" value="1 + ({{star_level}} > 2 ? 0.5 : 0) + ({{star_level}} > 4 ? 0.5 : 0)" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                    <span class="tooltip">
                        Formula for Range. <br/>
                        Available variable: `{{star_level}}` (Star Level)
                    </span>
                </div>
            </div>

            <div class="mt-8 space-y-4">
                <h3 class="font-bold text-gray-300 mb-2">Rarity Multipliers</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="tooltip-container">
                            <label for="common_dps_mult" class="block text-sm font-medium text-gray-400">Common (DPS)</label>
                            <input type="number" id="common_dps_mult" value="1.00" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                        <div class="tooltip-container">
                            <label for="good_dps_mult" class="block text-sm font-medium text-gray-400">Good (DPS)</label>
                            <input type="number" id="good_dps_mult" value="1.15" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                        <div class="tooltip-container">
                            <label for="rare_dps_mult" class="block text-sm font-medium text-gray-400">Rare (DPS)</label>
                            <input type="number" id="rare_dps_mult" value="1.38" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                        <div class="tooltip-container">
                            <label for="epic_dps_mult" class="block text-sm font-medium text-gray-400">Epic (DPS)</label>
                            <input type="number" id="epic_dps_mult" value="1.65" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                    </div>
                    <div>
                        <div class="tooltip-container">
                            <label for="common_aspd_mult" class="block text-sm font-medium text-gray-400">Common (ASPD)</label>
                            <input type="number" id="common_aspd_mult" value="1.00" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                        <div class="tooltip-container">
                            <label for="good_aspd_mult" class="block text-sm font-medium text-gray-400">Good (ASPD)</label>
                            <input type="number" id="good_aspd_mult" value="1.05" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                        <div class="tooltip-container">
                            <label for="rare_aspd_mult" class="block text-sm font-medium text-gray-400">Rare (ASPD)</label>
                            <input type="number" id="rare_aspd_mult" value="1.10" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                        <div class="tooltip-container">
                            <label for="epic_aspd_mult" class="block text-sm font-medium text-gray-400">Epic (ASPD)</label>
                            <input type="number" id="epic_aspd_mult" value="1.15" step="0.01" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Settings -->
            <div class="mt-8 space-y-4">
                <h3 class="font-bold text-gray-300 mb-2">General Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="tooltip-container">
                        <label for="slow_percent" class="block text-sm font-medium text-gray-400">Slow (%)</label>
                        <input type="number" id="slow_percent" value="20" step="1" min="0" max="100" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        <span class="tooltip">The slowing percentage applied by the tower.</span>
                    </div>
                    <div class="tooltip-container">
                        <label for="dps_loss_percent" class="block text-sm font-medium text-gray-400">DPS Loss due to Slow (%)</label>
                        <input type="number" id="dps_loss_percent" value="0" step="1" min="0" max="100" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        <span class="tooltip">The percentage of DPS lost when the slow effect is active.</span>
                    </div>
                    <div class="tooltip-container">
                        <label for="aspd_reduce_percent" class="block text-sm font-medium text-gray-400">Reduce Attack Speed (%)</label>
                        <input type="number" id="aspd_reduce_percent" value="0" step="1" min="0" max="100" class="mt-1 block w-full rounded-md bg-gray-700 text-gray-200 border-gray-600 shadow-sm p-2.5 focus:border-custom-purple focus:ring focus:ring-custom-purple focus:ring-opacity-50">
                        <span class="tooltip">The percentage reduction in attack speed applied by the tower.</span>
                    </div>
                </div>
                <h3 class="font-bold text-gray-300 mt-6 mb-2">Target Type</h3>
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                    <button id="ground_target" class="target-button selected" onclick="toggleTarget('ground_target')">
                        Ground
                    </button>
                    <button id="air_target" class="target-button selected" onclick="toggleTarget('air_target')">
                        Air
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <button onclick="generateStats()" class="w-full bg-custom-orange text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-custom-orange focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors mb-4">
            Calculate Stats and Generate Table
        </button>

        <!-- Generated Table & Copy Button -->
        <div id="results_section" class="mt-8 hidden p-6 bg-gray-800 rounded-xl shadow-md border border-gray-700">
            <h3 class="text-xl font-semibold text-custom-purple mb-4">Generated Stats Table</h3>
            <div class="overflow-x-auto">
                <table id="stats_table" class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Star Lvl</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rarity</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tier</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Raw DPS</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Effective DPS</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Raw ASPD</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Effective ASPD</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Range</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Targets</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Slow %</th>
                        </tr>
                    </thead>
                    <tbody id="stats_table_body" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Table rows will be added here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <button onclick="copyFormulasToClipboard()" class="mt-6 w-full md:w-auto bg-gray-700 text-gray-200 font-bold py-2 px-6 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors">
                Copy Formula Data (TSV)
            </button>
        </div>

    </div>

    <script>
        let generatedData = [];

        function toggleTarget(buttonId) {
            const button = document.getElementById(buttonId);
            button.classList.toggle('selected');
        }

        function showNotification(message) {
            const notification = document.getElementById('copy_notification');
            notification.textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 2000);
        }

        function evaluateFormula(formula, variables) {
            try {
                // Simplified evaluation for the JS preview
                let evalFormula = formula;
                for (const key in variables) {
                    evalFormula = evalFormula.replace(new RegExp(`{{${key}}}`, 'g'), variables[key]);
                }
                const result = new Function('return ' + evalFormula)();
                return result;
            } catch (e) {
                console.error("Formula error:", e);
                return "ERROR";
            }
        }
        
        function getVariableValues() {
            return {
                base_dps: parseFloat(document.getElementById('base_dps').value),
                base_aspd: parseFloat(document.getElementById('base_aspd').value),
                dmg_increment: parseFloat(document.getElementById('dmg_increment_per_tier').value),
                slow_percent: parseFloat(document.getElementById('slow_percent').value),
                dps_loss_percent: parseFloat(document.getElementById('dps_loss_percent').value),
                aspd_reduce_percent: parseFloat(document.getElementById('aspd_reduce_percent').value),
                is_ground: document.getElementById('ground_target').classList.contains('selected'),
                is_air: document.getElementById('air_target').classList.contains('selected'),
                rarity_mults: {
                    'Common': { dps: parseFloat(document.getElementById('common_dps_mult').value), aspd: parseFloat(document.getElementById('common_aspd_mult').value) },
                    'Good': { dps: parseFloat(document.getElementById('good_dps_mult').value), aspd: parseFloat(document.getElementById('good_aspd_mult').value) },
                    'Rare': { dps: parseFloat(document.getElementById('rare_dps_mult').value), aspd: parseFloat(document.getElementById('rare_aspd_mult').value) },
                    'Epic': { dps: parseFloat(document.getElementById('epic_dps_mult').value), aspd: parseFloat(document.getElementById('epic_aspd_mult').value) },
                }
            };
        }

        function generateStats() {
            const vars = getVariableValues();
            const dpsFormula = document.getElementById('dps_formula').value;
            const aspdFormula = document.getElementById('aspd_formula').value;
            const rangeFormula = document.getElementById('range_formula').value;

            let targets = [];
            if (vars.is_ground) targets.push('Ground');
            if (vars.is_air) targets.push('Air');
            const targetString = targets.join(' & ');
            
            const rarityTierMap = {
                'Common': { tiers: 10, dpsMult: vars.rarity_mults.Common.dps, aspdMult: vars.rarity_mults.Common.aspd },
                'Good': { tiers: 20, dpsMult: vars.rarity_mults.Good.dps, aspdMult: vars.rarity_mults.Good.aspd },
                'Rare': { tiers: 30, dpsMult: vars.rarity_mults.Rare.dps, aspdMult: vars.rarity_mults.Rare.aspd },
                'Epic': { tiers: 40, dpsMult: vars.rarity_mults.Epic.dps, aspdMult: vars.rarity_mults.Epic.aspd },
            };
            const starLevels = [1, 2, 3, 4, 5, 6];

            generatedData = [];

            for (const rarity in rarityTierMap) {
                for (const starLvl of starLevels) {
                    const rarityData = rarityTierMap[rarity];
                    for (let tier = 1; tier <= rarityData.tiers; tier++) {
                        const variables = {
                            tier: tier,
                            star_level: starLvl,
                            rarity_mult: rarityData.dpsMult,
                            rarity_mult_aspd: rarityData.aspdMult,
                            base_dps: vars.base_dps,
                            base_aspd: vars.base_aspd,
                            dmg_increment: vars.dmg_increment
                        };

                        const rawDpsResult = evaluateFormula(dpsFormula, variables);
                        const rawAspdResult = evaluateFormula(aspdFormula, variables);
                        const rangeResult = evaluateFormula(rangeFormula, variables);
                        
                        const effectiveDpsResult = (vars.slow_percent > 0 && vars.dps_loss_percent > 0) 
                            ? rawDpsResult * (1 - vars.dps_loss_percent / 100) 
                            : rawDpsResult;

                        const effectiveAspdResult = (vars.aspd_reduce_percent > 0)
                            ? rawAspdResult * (1 - vars.aspd_reduce_percent / 100)
                            : rawAspdResult;

                        generatedData.push({
                            starLvl: starLvl,
                            rarity: rarity,
                            tier: tier,
                            rawDps: typeof rawDpsResult === 'number' ? rawDpsResult.toFixed(2) : rawDpsResult,
                            effectiveDps: typeof effectiveDpsResult === 'number' ? effectiveDpsResult.toFixed(2) : effectiveDpsResult,
                            rawAspd: typeof rawAspdResult === 'number' ? rawAspdResult.toFixed(2) : rawAspdResult,
                            effectiveAspd: typeof effectiveAspdResult === 'number' ? effectiveAspdResult.toFixed(2) : effectiveAspdResult,
                            range: typeof rangeResult === 'number' ? rangeResult.toFixed(2) : rangeResult,
                            targets: targetString || 'None',
                            slow: `${vars.slow_percent}%`
                        });
                    }
                }
            }

            let tableBody = document.getElementById('stats_table_body');
            tableBody.innerHTML = '';
            
            const sampleRows = generatedData.slice(0, 10);
            sampleRows.forEach(rowData => {
                 const row = `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.starLvl}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.rarity}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.tier}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.rawDps}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.effectiveDps}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.rawAspd}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.effectiveAspd}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.range}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.targets}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${rowData.slow}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            document.getElementById('results_section').classList.remove('hidden');
        }

        function copyFormulasToClipboard() {
            const vars = getVariableValues();
            const dpsFormulaTemplate = document.getElementById('dps_formula').value;
            const aspdFormulaTemplate = document.getElementById('aspd_formula').value;
            const rangeFormulaTemplate = document.getElementById('range_formula').value;

            let tsvData = [];
            const headers = ["Star Level", "Rarity", "Tier", "Raw DPS", "Effective DPS", "Raw ASPD", "Effective ASPD", "Range", "Targets", "Slow %"];
            tsvData.push(headers.join('\t'));

            const rarityTierMap = {
                'Common': { tiers: 10, dpsMult: vars.rarity_mults.Common.dps, aspdMult: vars.rarity_mults.Common.aspd },
                'Good': { tiers: 20, dpsMult: vars.rarity_mults.Good.dps, aspdMult: vars.rarity_mults.Good.aspd },
                'Rare': { tiers: 30, dpsMult: vars.rarity_mults.Rare.dps, aspdMult: vars.rarity_mults.Rare.aspd },
                'Epic': { tiers: 40, dpsMult: vars.rarity_mults.Epic.dps, aspdMult: vars.rarity_mults.Epic.aspd },
            };
            const starLevels = [1, 2, 3, 4, 5, 6];

            let targets = [];
            if (vars.is_ground) targets.push('Ground');
            if (vars.is_air) targets.push('Air');
            const targetString = targets.length > 0 ? targets.join(' & ') : "None";

            for (const rarity in rarityTierMap) {
                for (const starLvl of starLevels) {
                    const rarityData = rarityTierMap[rarity];
                    for (let tier = 1; tier <= rarityData.tiers; tier++) {

                        // Replace variables with their actual values in the formula string
                        let rawDpsFormula = dpsFormulaTemplate
                            .replace(/{{base_dps}}/g, vars.base_dps)
                            .replace(/{{rarity_mult}}/g, rarityData.dpsMult)
                            .replace(/{{dmg_increment}}/g, vars.dmg_increment)
                            .replace(/{{tier}}/g, tier);
                        
                        let rawAspdFormula = aspdFormulaTemplate
                            .replace(/{{base_aspd}}/g, vars.base_aspd)
                            .replace(/{{rarity_mult_aspd}}/g, rarityData.aspdMult);
                            
                        let rangeFormula = rangeFormulaTemplate
                            .replace(/{{star_level}}/g, starLvl);
                        
                        // Replace JS ternary operator with Excel-compatible IF
                        rangeFormula = rangeFormula.replace(/\s\?\s/g, ",");
                        rangeFormula = rangeFormula.replace(/\s:\s/g, ",");


                        // Now, create the Effective DPS and ASPD formulas using the simplified format
                        const effectiveDpsFormula = `=IF(${vars.slow_percent}>0, (${rawDpsFormula}) * (1 - ${vars.dps_loss_percent / 100}), (${rawDpsFormula}))`;
                        const effectiveAspdFormula = `=IF(${vars.aspd_reduce_percent}>0, (${rawAspdFormula}) * (1 - ${vars.aspd_reduce_percent / 100}), (${rawAspdFormula}))`;
                        
                        const row = [
                            starLvl,
                            rarity,
                            tier,
                            `=(${rawDpsFormula})`,
                            effectiveDpsFormula,
                            `=(${rawAspdFormula})`,
                            effectiveAspdFormula,
                            `=IF(${starLvl}>2, 1.5, IF(${starLvl}>4, 2, 1))`,
                            targetString,
                            `${vars.slow_percent}%`,
                        ];

                        // Join the row with tabs
                        tsvData.push(row.join('\t'));
                    }
                }
            }
            
            const el = document.createElement('textarea');
            el.value = tsvData.join('\n');
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            showNotification('Formula data copied to clipboard!');
        }
    </script>
</body>
</html>
